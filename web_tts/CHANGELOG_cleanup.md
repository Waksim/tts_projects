# Changelog: Автоматическое удаление аудио-файлов

## Дата: 2025-10-23

### Добавлено

✅ **Автоматическое удаление аудио-файлов через 10 минут после создания**

Реализована система автоматической очистки аудио-файлов, которая предотвращает захламление диска.

### Изменения в коде

#### 1. Новая функция `schedule_file_deletion()` (main.py:137-154)

```python
async def schedule_file_deletion(file_path: Path, delay_minutes: int = 10):
    """
    Планирует удаление файла через указанное время.
    
    Args:
        file_path: Путь к файлу для удаления
        delay_minutes: Время задержки перед удалением (в минутах)
    """
```

**Особенности:**
- Асинхронное выполнение (не блокирует основной поток)
- Надежная обработка ошибок
- Логирование в консоль

#### 2. Эндпоинт `/synthesize` (main.py:220)

Добавлена фоновая задача после успешного синтеза текста:
```python
asyncio.create_task(schedule_file_deletion(audio_path, delay_minutes=10))
```

#### 3. Эндпоинт `/synthesize_document` (main.py:310)

Добавлена фоновая задача после успешного синтеза документа:
```python
asyncio.create_task(schedule_file_deletion(audio_path, delay_minutes=10))
```

### Как это работает

1. **Пользователь создает аудио** (через текст или документ)
2. **Файл сохраняется** в `/audio/{uuid}.mp3`
3. **Запускается фоновая задача** с таймером на 10 минут
4. **Пользователь может:**
   - Прослушать аудио в браузере
   - Скачать MP3 файл
   - Повторно скачать/прослушать в течение 10 минут
5. **Через 10 минут файл автоматически удаляется**

### Технические детали

- **Реализация**: `asyncio.create_task()` + `asyncio.sleep()`
- **Зависимости**: Не требует дополнительных библиотек
- **Производительность**: Не блокирует обработку запросов
- **Совместимость**: Работает вместе с существующим `StorageManager`

### StorageManager vs Автоматическая очистка

| Механизм | Триггер | Назначение |
|----------|---------|------------|
| **StorageManager** | При превышении 500MB | Резервная защита от переполнения диска |
| **Автоматическая очистка** | Через 10 минут после создания | Регулярная очистка файлов |

Оба механизма работают параллельно и дополняют друг друга.

### Тестирование

Созданы и успешно пройдены тесты:
- ✅ Удаление одиночного файла
- ✅ Одновременное удаление нескольких файлов
- ✅ Корректная обработка ошибок

### Логи

При удалении файла в консоли появится сообщение:
```
[Cleanup] Автоматически удален файл: {uuid}.mp3 (через 10 минут после создания)
```

### Настройка

Время задержки можно изменить, передав параметр `delay_minutes`:

```python
# Удаление через 5 минут вместо 10
asyncio.create_task(schedule_file_deletion(audio_path, delay_minutes=5))
```

### Совместимость

- Python 3.10+
- FastAPI (без изменений версии)
- Не влияет на существующий функционал
- Обратно совместимо со всеми существующими эндпоинтами
