# Структура проекта TTS Projects

## Обзор

Два независимых проекта для озвучивания текста:
- **Telegram Bot** - озвучивает текст, документы и веб-страницы через Telegram
- **Web TTS** - веб-приложение с интерфейсом для озвучивания текста

Оба проекта используют общую библиотеку `tts_common`.

## Полная структура файлов

```
tts_projects/
│
├── README.md                      # Основная документация
├── DEPLOYMENT.md                  # Инструкции по развертыванию
├── PROJECT_STRUCTURE.md           # Этот файл
│
├── tts_common/                    # Общая библиотека
│   ├── __init__.py               # Экспорт публичного API
│   ├── tts_service.py            # Основная логика синтеза речи
│   ├── text_utils.py             # Утилиты обработки текста
│   ├── document_parser.py        # Парсинг документов (txt, docx, pdf, md, rtf, epub, fb2)
│   ├── web_parser.py             # Парсинг веб-страниц (trafilatura)
│   ├── storage_manager.py        # Управление хранилищем (лимит 500MB)
│   └── requirements.txt          # Зависимости библиотеки
│
├── telegram_bot/                  # Telegram Bot проект
│   ├── README.md                 # Документация бота
│   ├── main.py                   # Точка входа, запуск бота
│   ├── config.py                 # Конфигурация (токен, настройки)
│   ├── models.py                 # Модели SQLAlchemy (Request)
│   ├── database.py               # Настройка БД и сессий
│   ├── handlers.py               # Обработчики команд и сообщений
│   ├── requirements.txt          # Зависимости проекта
│   ├── .env.example              # Пример файла переменных окружения
│   ├── start.sh                  # Скрипт запуска (для разработки)
│   ├── tts-bot.service           # Systemd unit файл
│   ├── audio/                    # Директория для аудиофайлов (создается автоматически)
│   └── bot_history.db            # База данных SQLite (создается автоматически)
│
└── web_tts/                       # Web TTS проект
    ├── README.md                 # Документация приложения
    ├── main.py                   # FastAPI приложение
    ├── requirements.txt          # Зависимости проекта
    ├── start.sh                  # Скрипт запуска (для разработки)
    ├── tts-web.service           # Systemd unit файл
    ├── templates/                # Jinja2 шаблоны
    │   └── index.html           # Главная страница
    ├── static/                   # Статические файлы (создается автоматически)
    └── audio/                    # Директория для аудиофайлов (создается автоматически)
```

## Описание компонентов

### tts_common - Общая библиотека

**Назначение:** Переиспользуемая библиотека для синтеза речи и обработки текста.

**Основные модули:**

1. **tts_service.py** (370 строк)
   - `synthesize_text()` - основная функция синтеза
   - `_synthesize_single_chunk()` - синтез одного фрагмента с повторами
   - `_merge_mp3_parts()` - склейка MP3 частей через FFmpeg
   - Использует Microsoft Edge TTS API (`edge-tts`)
   - Параллельная обработка чанков с семафором (10 concurrent)
   - Валидация файлов по размеру

2. **text_utils.py** (200 строк)
   - `clean_text_for_tts()` - очистка текста от markdown и спецсимволов
   - `split_text_into_chunks()` - умное разбиение на части (по абзацам и предложениям)
   - `sanitize_filename()` - безопасные имена файлов
   - Удаляет: #, *, `, [], (), >, таблицы, списки

3. **document_parser.py** (260 строк)
   - `parse_document()` - универсальный парсер
   - Поддержка форматов: txt, docx, pdf, md, rtf, epub, fb2
   - Автоопределение типа файла по расширению и MIME
   - Обработка различных кодировок для txt

4. **web_parser.py** (80 строк)
   - `parse_url()` - извлечение текста из веб-страниц
   - `parse_url_async()` - асинхронная версия
   - Использует `trafilatura` для умного извлечения контента
   - `is_valid_url()` - валидация URL

5. **storage_manager.py** (150 строк)
   - `StorageManager` - класс для управления хранилищем
   - Автоматическое удаление старых файлов при превышении лимита
   - Сортировка файлов по времени модификации
   - Статистика использования

### telegram_bot - Telegram Bot

**Назначение:** Озвучивание текста через Telegram бота.

**Основные модули:**

1. **main.py** (70 строк)
   - Инициализация бота (aiogram 3.x)
   - Настройка логирования (файл + консоль)
   - Подключение обработчиков
   - Lifecycle management

2. **config.py** (40 строк)
   - BOT_TOKEN
   - Пути к директориям и БД
   - TTS настройки (голос, скорость)
   - Лимиты (размер текста, файла)
   - Шаблоны сообщений

3. **models.py** (30 строк)
   - `Request` - модель для истории запросов
   - Поля: user_id, username, request_type, content, audio_path, status, error_message, created_at

4. **database.py** (60 строк)
   - Настройка async SQLAlchemy + aiosqlite
   - `init_db()` - создание таблиц
   - `save_request()` - сохранение записи в историю

5. **handlers.py** (400 строк)
   - `/start` - приветствие
   - `/help` - справка
   - `/stats` - статистика хранилища
   - `handle_document()` - обработка файлов
   - `handle_text()` - обработка текста и URL
   - `handle_url()` - парсинг веб-страниц
   - `handle_plain_text()` - синтез текста
   - Прогресс-бары, статусы "печатает", "записывает голос"

**База данных:**
- SQLite файл: `bot_history.db`
- Таблица: `requests`
- Автоматическое создание при первом запуске

### web_tts - Web TTS приложение

**Назначение:** Веб-интерфейс для озвучивания текста.

**Основные модули:**

1. **main.py** (180 строк)
   - FastAPI приложение
   - Эндпоинты:
     - `GET /` - главная страница
     - `POST /synthesize` - синтез речи
     - `GET /audio/{file_id}` - получение MP3
     - `GET /stats` - статистика хранилища
   - Lifecycle manager (создание директорий)
   - Интеграция с StorageManager

2. **templates/index.html** (350 строк)
   - Адаптивный дизайн
   - Темная/светлая тема (auto)
   - Textarea с счетчиком символов
   - Слайдер скорости речи (-50% до +100%)
   - Прогресс-бар синтеза
   - HTML5 audio плеер
   - Кнопка скачивания MP3
   - JavaScript для взаимодействия с API

**Интерфейс:**
- Чистый, минималистичный дизайн
- Без внешних зависимостей (Vanilla JS)
- Поддержка темной темы через CSS `prefers-color-scheme`

## Зависимости

### tts_common
```
edge-tts >= 6.1.0          # Microsoft Edge TTS
python-docx >= 1.0.0       # DOCX парсинг
pdfplumber >= 0.10.0       # PDF парсинг
striprtf >= 0.0.26         # RTF парсинг
EbookLib >= 0.18           # EPUB парсинг
trafilatura >= 1.6.0       # Веб-парсинг
beautifulsoup4 >= 4.12.0   # HTML парсинг
lxml >= 4.9.0              # XML/HTML парсинг
aiofiles >= 23.0.0         # Async file I/O
```

### telegram_bot
```
aiogram >= 3.4.0           # Telegram Bot framework
sqlalchemy[asyncio] >= 2.0.0  # ORM
aiosqlite >= 0.19.0        # Async SQLite
python-dotenv >= 1.0.0     # .env файлы
+ все зависимости tts_common
```

### web_tts
```
fastapi >= 0.109.0         # Web framework
uvicorn[standard] >= 0.27.0  # ASGI server
jinja2 >= 3.1.0            # Шаблонизатор
+ все зависимости tts_common
```

### Системные требования
```
Python >= 3.10
FFmpeg (для склейки MP3)
```

## Основные фичи

### Telegram Bot
✅ Озвучивание текста (до 50,000 символов)
✅ Поддержка документов: txt, docx, pdf, md, rtf, epub, fb2
✅ Парсинг веб-страниц по URL
✅ История запросов в SQLite
✅ Автоматическое управление хранилищем (500 MB)
✅ Статусы обработки (typing, recording)
✅ Прогресс-бары
✅ Обработка ошибок

### Web TTS
✅ Веб-интерфейс для ввода текста
✅ Настройка скорости речи (слайдер)
✅ Прослушивание аудио на сайте
✅ Скачивание MP3 файлов
✅ Счетчик символов
✅ Прогресс-бар синтеза
✅ Статистика хранилища
✅ Темная/светлая тема

### Общие возможности (tts_common)
✅ Высококачественный синтез (Microsoft Edge TTS)
✅ Умная обработка длинных текстов (автоматическое разбиение)
✅ Параллельная обработка частей (ускорение в 3-5 раз)
✅ Валидация результата по размеру файла
✅ Retry механизм с экспоненциальной задержкой
✅ Автоматическая очистка хранилища
✅ Расширенная очистка markdown разметки
✅ Поддержка 7+ форматов документов
✅ Умный парсинг веб-страниц

## Конфигурация по умолчанию

### TTS параметры
- Голос: `ru-RU-DmitryNeural` (мужской)
- Скорость: `+50%`
- Высота тона: `+0Hz`
- Chunk limit: 3000 символов
- Max concurrent: 10 запросов

### Лимиты
- Максимум текста: 50,000 символов
- Максимум файла: 20 MB
- Хранилище: 500 MB
- Попытки retry: 3

### Порты
- Web TTS: 8001
- Telegram Bot: не использует порты (polling)

## Производительность

### Скорость синтеза
- ~1000 символов = ~3-5 секунд (одна часть)
- ~10,000 символов = ~10-15 секунд (параллельная обработка)
- ~50,000 символов = ~40-60 секунд

### Потребление ресурсов
- RAM: ~100-200 MB на проект
- CPU: пики при синтезе
- Disk I/O: минимальный
- Network: зависит от нагрузки

### Оптимизация для 1GB RAM
- TTS_SEMAPHORE = 5 (вместо 10)
- MAX_STORAGE_MB = 250 (вместо 500)
- Uvicorn workers = 1
- Swap 2GB рекомендуется

## Развертывание

### Варианты запуска

1. **Разработка (локально):**
   ```bash
   ./start.sh
   ```

2. **Production (systemd):**
   ```bash
   sudo systemctl start tts-bot
   sudo systemctl start tts-web
   ```

3. **Production (screen):**
   ```bash
   screen -dmS tts-bot python main.py
   screen -dmS tts-web python main.py
   ```

### Файлы для развертывания
- `tts-bot.service` - systemd unit для бота
- `tts-web.service` - systemd unit для веб-приложения
- `start.sh` - скрипты быстрого запуска
- `DEPLOYMENT.md` - подробная инструкция

## Логирование

### Telegram Bot
- Файл: `bot.log`
- Формат: timestamp - name - level - message
- Rotation: нет (рекомендуется настроить)

### Web TTS
- Stdout/stderr (управляется uvicorn)
- При systemd: `/var/log/tts-web.log`

## Безопасность

### Текущее состояние
- ⚠️ Нет аутентификации (публичный доступ)
- ⚠️ Нет rate limiting
- ✅ Валидация входных данных
- ✅ Санитизация имен файлов
- ✅ UUID для файлов (предотвращение перезаписи)

### Рекомендации
- Использовать за nginx с basic auth
- Добавить whitelist IP адресов
- Настроить rate limiting
- Использовать HTTPS (через nginx)

## Тестирование

### Ручное тестирование

**Telegram Bot:**
1. `/start` - проверка запуска
2. Отправить текст
3. Отправить документ (docx, pdf)
4. Отправить URL
5. `/stats` - проверка хранилища

**Web TTS:**
1. Открыть браузер
2. Ввести текст
3. Изменить скорость
4. Нажать "Озвучить"
5. Прослушать аудио
6. Скачать MP3

### Проверка производительности
```bash
# Размер хранилища
du -sh audio/

# Использование памяти
ps aux | grep python

# Логи ошибок
grep ERROR bot.log
sudo journalctl -u tts-web | grep ERROR
```

## Лицензия

MIT License

## Автор

Проект создан для озвучивания текста с использованием Microsoft Edge TTS API.

---

**Версия:** 1.0
**Дата создания:** 2025-10-19
**Python:** 3.10+
